name: Daily Data Update & Retrain

on:
  schedule:
    # Job 1: Append daily prices lúc 10:00 UTC = 17:00 SA Giờ VN
    - cron: '0 10 * * 1-5'
    # Job 2: Retrain models lúc 01:00 UTC = 08:00 SA Giờ VN (hôm sau)
    - cron: '0 1 * * 2-6'
  workflow_dispatch:
    inputs:
      job:
        description: 'Which job to run?'
        required: false
        default: 'all'
        type: choice
        options:
          - 'all'
          - 'append_prices'
          - 'retrain'

jobs:
  # ─────────────────────────────────────────────────────────────────────────
  # JOB 1: Append daily prices (17:00 SA VN = 10:00 UTC, Mon-Fri)
  # ─────────────────────────────────────────────────────────────────────────
  append-daily-prices:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: |
      github.event_name == 'workflow_dispatch' && (github.event.inputs.job == 'all' || github.event.inputs.job == 'append_prices') ||
      (github.event_name == 'schedule' && (github.event.schedule == '0 10 * * 1-5'))

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install \
            numpy pandas requests \
            "beautifulsoup4>=4.12.0" \
            "lxml>=4.9.0" \
            "yfinance>=0.2.0"

      - name: Append today's Gold (SJC) price
        run: |
          echo "=== Appending Gold SJC price ==="
          python append_daily_prices.py --gold
        continue-on-error: true

      - name: Append today's Silver price
        run: |
          echo "=== Appending Silver price ==="
          python append_daily_prices.py --silver
        continue-on-error: true

      - name: Commit and push new prices
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add dataset/gold_price_sjc_complete.csv || true
          git add dataset/dataset_enhanced.csv || true

          if git diff --cached --quiet; then
            echo "No new price data to commit today."
          else
            DATE=$(date -u '+%Y-%m-%d')
            git commit -m "data: Append daily prices ${DATE} [skip ci]

          - Gold SJC: scraped from webgia.com / btmc.vn
          - Silver: fetched from Yahoo Finance (SI=F)"
            git push origin main
            echo "Pushed new price data!"
          fi

  # ─────────────────────────────────────────────────────────────────────────
  # JOB 2: Retrain models (08:00 SA VN = 01:00 UTC, Tue-Sat)
  # ─────────────────────────────────────────────────────────────────────────
  retrain-models:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    if: |
      github.event_name == 'workflow_dispatch' && (github.event.inputs.job == 'all' || github.event.inputs.job == 'retrain') ||
      (github.event_name == 'schedule' && (github.event.schedule == '0 1 * * 2-6'))

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1

      - name: Pull latest data (from Job 1 commit)
        run: git pull origin main

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install \
            numpy>=1.21.0 \
            pandas>=1.3.0 \
            scikit-learn>=1.0.0 \
            "xgboost>=1.7.0,<2.1" \
            yfinance>=0.2.0 \
            joblib \
            requests \
            lunardate \
            "beautifulsoup4>=4.12.0" \
            lxml

      - name: Update world datasets (Yahoo Finance)
        run: |
          echo "=== Updating world datasets ==="
          python update_data.py
        continue-on-error: true

      - name: Retrain Silver model
        run: |
          echo "=== Retraining Silver model ==="
          python update_data.py --silver-only --retrain
        continue-on-error: true

      - name: Retrain Gold model
        run: |
          echo "=== Retraining Gold model ==="
          python update_data.py --gold-only --retrain
        continue-on-error: true

      - name: Commit and push updated models
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add dataset/dataset_enhanced.csv || true
          git add dataset/gold_geopolitical_dataset.csv || true
          git add models/ridge_enhanced_models.pkl || true
          git add models/vietnam_gold_models.pkl || true

          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M UTC')
            git commit -m "auto: Retrain models [${TIMESTAMP}]

          - Updated world datasets from Yahoo Finance
          - Retrained Silver model (Ridge + XGBoost)
          - Retrained Gold model (Transfer Learning + XGBoost)
          [skip ci]"
            git push origin main
            echo "Pushed retrained models!"
          fi

      - name: Print dataset summary
        run: |
          python -c "
          import pandas as pd
          from datetime import datetime

          try:
              df = pd.read_csv('dataset/dataset_enhanced.csv')
              df['Date'] = pd.to_datetime(df['Date'])
              print(f'Silver dataset: {len(df)} rows, last={df[\"Date\"].max().date()}')
          except Exception as e:
              print(f'Silver: ERROR - {e}')

          try:
              df = pd.read_csv('dataset/gold_price_sjc_complete.csv')
              df['date'] = pd.to_datetime(df['date'])
              print(f'Gold SJC dataset: {len(df)} rows, last={df[\"date\"].max().date()}')
          except Exception as e:
              print(f'Gold SJC: ERROR - {e}')

          try:
              df = pd.read_csv('dataset/gold_geopolitical_dataset.csv')
              df['date'] = pd.to_datetime(df['date'])
              print(f'Gold World dataset: {len(df)} rows, last={df[\"date\"].max().date()}')
          except Exception as e:
              print(f'Gold World: ERROR - {e}')
          "
